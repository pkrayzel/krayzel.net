<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Pavel Krayzel">
    <meta name="description" content="https://www.krayzel.net/">
    <meta name="keywords" content="blog,developer,personal,aws">

    <meta property="og:site_name" content="Home">
    <meta property="og:title" content="
  Intervention Ninja - build flask app docker image (#02) - Home
">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.krayzel.net/posts/003-intervention-ninja-build-flask-app-docker-image/">
    <meta property="og:image" content="https://www.krayzel.net/images/tn.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="https://www.krayzel.net/posts/003-intervention-ninja-build-flask-app-docker-image/">
    <meta name="twitter:image" content="https://www.krayzel.net/images/tn.png">

    <base href="https://www.krayzel.net/">
    <title>
  Intervention Ninja - build flask app docker image (#02) - Home
</title>

    <link rel="canonical" href="https://www.krayzel.net/posts/003-intervention-ninja-build-flask-app-docker-image/">
    
    <link  rel="stylesheet" href="https://www.krayzel.net/css/font.css">
    <link rel="stylesheet" href="https://www.krayzel.net/css/normalize.css">
    <link rel="stylesheet" href="https://www.krayzel.net/css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="https://www.krayzel.net/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://www.krayzel.net/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.51" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">Home</a>
    <input type="checkbox" id="menu-control"/>
    <label class="menu-mobile  float-right " for="menu-control">
      <span class="btn-mobile  float-right ">&#9776;</span>
      <ul class="navigation-list">
        
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://www.krayzel.net/posts">Blog</a>
            </li>
          
            <li class="navigation-item  align-center ">
              <a class="navigation-link" href="https://www.krayzel.net/about">About me</a>
            </li>
          
        
        
      </ul>
    </label>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">Intervention Ninja - build flask app docker image (#02)</h1>
      <h2 class="date">November 18, 2018</h2>

      
    </header>

    <p>In the <a href="posts/002-intervention-ninja-flask-app-running-on-aws-ecs">previous post</a>, I&rsquo;ve shared what we&rsquo;re going to build and why.
Today, we&rsquo;re gonna finally do some real work - we&rsquo;ll build flask application and we&rsquo;ll run it in docker.</p>

<p><strong>Let&rsquo;s get started</strong></p>

<p>I&rsquo;ll start with building a docker image for our flask application. Let&rsquo;s write a Dockerfile for it. I expect you to have some experience with docker, if you don&rsquo;t - I recommend you to check <a href="https://docker-curriculum.com/" target="_blank">this website</a>.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">FROM</span> <span class="nx">library</span><span class="o">/</span><span class="nx">python</span><span class="p">:</span><span class="nx">alpine3</span><span class="mf">.7</span>

<span class="nx">RUN</span> <span class="nx">pip</span> <span class="nx">install</span> <span class="nx">Flask</span><span class="o">==</span><span class="mf">0.12.2</span>

<span class="nx">ADD</span> <span class="p">.</span><span class="o">/</span><span class="nx">src</span> <span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">intervention</span><span class="o">-</span><span class="nx">ninja</span>
<span class="nx">WORKDIR</span> <span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">intervention</span><span class="o">-</span><span class="nx">ninja</span>

<span class="nx">EXPOSE</span> <span class="mi">5000</span>
<span class="nx">CMD</span> <span class="p">[</span><span class="s">&#34;python&#34;</span><span class="p">,</span> <span class="s">&#34;app.py&#34;</span><span class="p">]</span></code></pre></td></tr></table>
</div>
</div>

<p>Nothing really fancy here, we&rsquo;re using alpine version of Linux with python 3 (line 1).
We&rsquo;re installing flask on it using <a href="https://pypi.org/project/pip/" target="_blank">pip</a> (line 3)
and copying source files from <em>src</em> directory (line 5).
Line 6 is setting work directory to <em>/opt/intervention-ninja</em> - that&rsquo;s where we&rsquo;ve just copied source code of our application to.
Then we can run <em>python app.py</em> from that directory (line 9).</p>

<p>The main file for our flask application is <em>src/app.py</em> - I&rsquo;ll put only the most important pieces here and the rest will be available at the end of this post.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">@</span><span class="nx">app</span><span class="p">.</span><span class="nf">route</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">)</span>

<span class="err">@</span><span class="nx">app</span><span class="p">.</span><span class="nf">route</span><span class="p">(</span><span class="s">&#34;/send&#34;</span><span class="p">,</span> <span class="nx">methods</span><span class="p">=[</span><span class="s">&#34;POST&#34;</span><span class="p">])</span>
<span class="nx">def</span> <span class="nf">send_email</span><span class="p">():</span>
    <span class="nx">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">&#34;Pretending to sent email...&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="s">&#34;sent.html&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>

<p>So far our application have two endpoints - <strong>the root</strong> endpoint renders Jinja2 template file <strong>index.html</strong>.
The <strong>/send</strong> endpoint accepts POST request, sends an email (not really) and then renders Jinja2 template file <strong>sent.html</strong>.</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">@</span><span class="nx">app</span><span class="p">.</span><span class="nf">route</span><span class="p">(</span><span class="s">&#34;/_health&#34;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nf">health_check</span><span class="p">():</span>
    <span class="k">return</span> <span class="nf">make_response</span><span class="p">(</span>
        <span class="nf">jsonify</span><span class="p">({</span>
            <span class="s">&#34;version&#34;</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">&#34;VERSION&#34;</span><span class="p">,</span> <span class="s">&#34;N/A&#34;</span><span class="p">),</span>
            <span class="s">&#34;status&#34;</span><span class="p">:</span> <span class="s">&#34;AVAILABLE&#34;</span>
        <span class="p">}),</span>
        <span class="mi">200</span>
    <span class="p">)</span></code></pre></td></tr></table>
</div>
</div>

<p>The last section defines <strong>_health</strong> endpoint, which has one purpose - it should tell us
(or to the load balancer) whether this container can be shown to our customers or not.
In real life, this endpoint should return status based on the current state of the app, checking also it&rsquo;s
dependencies etc.</p>

<p>It&rsquo;s also a good practice to return version of the application from here, as it&rsquo;s very useful for debugging.</p>

<p>I won&rsquo;t show the rest of the files here as they&rsquo;re not really interesting - it&rsquo;s just a static content and bootstrap template.
Feel free to check all of them in the branch <a href="https://github.com/pkrayzel/intervention.ninja/tree/flask-ec2" target="_blank">flask-ec2</a>.
If you&rsquo;re not familiar with Jinja2 templates or macros, check <a href="http://jinja.pocoo.org/docs/2.10/" target="_blank">the docs</a> first.</p>

<p>The full structure of our project now looks like this:</p>

<p><img src="images/in_flask_structure.png" alt="Intervention Ninja flask app project structure" /></p>

<p>Great! Now let&rsquo;s build a docker image - run following command from your terminal.</p>
<div class="highlight"><pre class="chroma">docker build -t intervention-ninja .</pre></div>
<p>Docker daemon should execute all the steps from Dockerfile and last two lines in your terminal
should look similar to this (the <em>image id</em> will be different):</p>
<div class="highlight"><pre class="chroma">Successfully built 4549d6651033
Successfully tagged intervention-ninja:latest</pre></div>
<p><strong>Running the service</strong></p>

<p>We&rsquo;ll run our new docker image, expose it on our host (localhost) on port 5000 and we&rsquo;ll run it as daemon (so we can still use our terminal).</p>
<div class="highlight"><pre class="chroma">docker run -p 5000:5000 -d intervention-ninja</pre></div>
<p>Now let&rsquo;s check whether our docker container is running:</p>
<div class="highlight"><pre class="chroma">docker ps</pre></div>
<p>should give you a following input</p>
<div class="highlight"><pre class="chroma">CONTAINER ID        IMAGE                COMMAND             CREATED             STATUS              PORTS                    NAMES
ba8b6ddb34c6        intervention-ninja   &#34;python app.py&#34;     3 seconds ago       Up 1 second         0.0.0.0:5000-&gt;5000/tcp   priceless_darwin</pre></div>
<p>That looks promising. Now open your browser on url <a href="http://localhost:5000" target="_blank"><a href="http://localhost:5000">http://localhost:5000</a></a> and you should see:</p>

<p><img src="images/in_flask_index.png" alt="Intervention Ninja Flask - homepage" /></p>

<p>Let&rsquo;s put some email address into the form and let&rsquo;s click on the <strong>Send</strong> button. You should now be on the second page:</p>

<p><img src="images/in_flask_send.png" alt="Intervention Ninja Flask - homepage" /></p>

<p>Ok, that was fun! Of course we&rsquo;re not sending real emails - to be honest - i&rsquo;ve removed this part from the code for the purpose of this blog post.
Next task will be to ship this application to AWS ECS. Stay tuned!</p>

  </article>

  <br/>

  
  
</section>

      </div>
      
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-129379364-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  <script src="https://www.krayzel.net/js/app.js"></script>
  
  <script>
  (function($) {
    $(function() {
      $('#privateTrigger').on('click', function() {
        $('.private').slideToggle();
        $('#privateTriggerText').text("Thank You! Please share it if you like it");
      });
    });
   })(jQuery);
  </script>
  
  </body>
</html>
